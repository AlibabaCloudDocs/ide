# 分支节点实现特定时间执行任务最佳实践 {#concept_djk_4gs_lgb .concept}

## 分支节点产生背景 {#section_c3m_pgs_lgb .section}

在日常DataWorks的使用过程中，您可能经常遇到如下问题：我有一个节点，需要每个月的最后一个天执行，应该如何设置？

答：在[分支节点](../../../../../intl.zh-CN/使用指南/数据开发/节点类型/分支节点.md#)出现之前，由于Cron表达式无法表达这种场景，所以暂时无法支持。

现在，DataWorks已经[正式支持分支节点](../../../../../intl.zh-CN/产品简介/版本历史.md#)。利用分支节点，我们可以套用switch-case编程模型完美满足上述需求。

## 分支节点与其他控制节点 {#section_qcb_drs_lgb .section}

在数据开发页面，您可以看到当前DataWorks支持的各种**控制节点**，包括赋值、分支、归并节点等。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081537235_zh-CN.png)

各类型控制节点作用：

-   能把自己的结果传给下游的**赋值节点**：

    [赋值节点](../../../../../intl.zh-CN/使用指南/数据开发/节点类型/赋值节点.md#)复用了[节点上下文](../../../../../intl.zh-CN/使用指南/数据开发/调度配置/节点上下文.md#)依赖的特性，在已有常量/变量两种节点上下文的基础上，赋值节点自带一种自定义的上下文输出。DataWorks会捕获赋值节点的select结果或者打印结果，把这个结果以outputs形式作为上下文输出参数的值供下游节点引用。

-   能决定哪些下游正常执行的**分支节点**：

    [分支节点](../../../../../intl.zh-CN/使用指南/数据开发/节点类型/分支节点.md#)复用了DataWorks上依赖关系设置的[输入输出](../../../../../intl.zh-CN/使用指南/数据开发/调度配置/依赖关系.md#)的特性。

    对于普通节点，节点的输出仅仅是一个全局唯一的字符串。当下游需要设置依赖时，搜索这个全局唯一的字符串作为节点的输入就能挂到下游节点列表中。

    但是，对于分支节点我们可以给每个输出关联一个条件：当下游设置依赖时可以选择性的把某一个条件关联的输出作为分支节点的输出。这样，节点在成为分支节点下游的同时，也关联到了分支节点的条件上：即满足了这个条件，这个输出对应的下游才会被正常执行；其他未满足条件的输出对应的下游节点会被置为空跑。

-   无论上游是否正常执行本身都会正常调度的**归并节点**：

    对于未被分支节点选中的分支，DataWorks会把这个分支链路上所有的节点实例均置为空跑实例，也就是说一旦某个实例的上游有一个实例是空跑的话，它本身也会变为空跑。

    DataWorks当前可以通过[归并节点](../../../../../intl.zh-CN/使用指南/数据开发/节点类型/归并节点.md#)来阻止这个空跑的属性无限制的传递下去：对于归并节点实例，无论它的上游有多少个空跑的实例，它都会直接成功并且不会再把下游置为空跑。


从下面这张图您可以看到在有分支节点的情况下，依赖树的逻辑关系。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081537237_zh-CN.png)

-   **ASN**：一个[赋值节点](../../../../../intl.zh-CN/使用指南/数据开发/节点类型/赋值节点.md#)，用于对比较复杂的情况做计算，为分支节点条件选择做准备。
-   **X/Y**：分支节点，他们处于赋值节点ASN下游，根据赋值节点的输出做分支的选择。如图中绿色线条所示，X节点选择了左边的分支，Y节点选择了左边两个分支：
    -   **A/C**节点由于处于了X/Y节点被选择的输出下游，因此正常执行。
    -   **B**节点虽然处于Y节点被选择的分支下游，但由于X节点未选择这个输出，因此B节点被置为空跑。
    -   **E**节点由于未被Y节点选中，因此即使有一个普通的Z节点上游，也同样被置为了空跑。
    -   **G**节点由于上游E节点空跑，因此即使C/F都正常执行，E节点同样把空跑
    -   空跑属性什么情况下才能不再向下传递？

        **JOIN节点**是一个**归并节点**，它的特殊功能就是停止空跑属性的传递，可以看到由于D节点处于JOIN节点下游，因此B节点的空跑属性被阻断了，D节点可以开始正常跑了。


我们可以通过利用分支节点配合其他控制节点，满足某个节点只有每个月最后一天运行的需求场景。

## 使用分支节点 {#section_e5l_4ts_lgb .section}

**定义任务依赖**

首先您需要定义一组任务依赖：

1.  根节点赋值节点通过定时时间SKYNET\_CYCTIME来计算当前是不是本月的最后一天，如果是则输出1，不是则输出0。这个输出会被DataWorks捕获，传递给下游。
2.  分支节点通过赋值节点的输出来定义分支。
3.  两个shell节点挂在分支节点下面，分别执行不同的分支逻辑。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081537238_zh-CN.png)

**定义赋值节点**

赋值节点新建时会自带一个outputs，赋值节点的代码支持SQL/SHELL/Python三种。

-   对于SQL类型，DataWorks捕获最后一条SELECT的SQL作为outputs的值。
-   对于SHELL/Python类型，DataWorks捕获最后一行标准输出作为outputs的值。

本文采用Python类型作为赋值节点的代码，调度属性和代码设置如下。

-   代码如下

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081537241_zh-CN.png)

-   调度属性配置

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637242_zh-CN.png)


**定义分支**

分支节点可以用简单的Python语法的表达式定义条件，每个条件会绑定一个输出。意味着当满足这个条件时，该输出下的下游节点会被执行起来，而其他的节点会被置为空跑。

-   调度配置

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637243_zh-CN.png)

-   分支配置

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637244_zh-CN.png)

-   调度配置生成条件绑定的输出

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637245_zh-CN.png)


**将执行任务节点挂在不同分支下**

最后，给真正执行任务的节点设置依赖的时需要注意：您可以看到分支节点已经有三个输出了，按照过去设置依赖的逻辑，把这三个输出中的任意一个当做输入即可；但是由于现在分支节点的输出关联了条件，所以要慎重选择。

-   每月最后一天执行的节点依赖

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637246_zh-CN.png)

-   每月其他时间执行的节点依赖

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637247_zh-CN.png)


**结果验证**

完成上述所有配置后，您可以提交并发布任务。完成发布后，可以执行[补数据](../../../../../intl.zh-CN/使用指南/运维中心/任务运维/补数据实例.md#)来测试效果：业务日期选择2018-12-30和2018-12-31，也就是定时时间分别为2018-12-31和2019-01-01，这样第一批补数据应该是会触发“最后一天”的逻辑，第二批触发“非最后一天”的逻辑，我们看看两者的区别。

**业务日期2018-12-30（定时时间2018-12-31）**

-   分支节点分支选择结果

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637248_zh-CN.png)

-   节点“最后一天执行”正常执行

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637249_zh-CN.png)

-   节点“除了最后一天之外运行”被置为空跑

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637250_zh-CN.png)


**业务日期2018-12-31（定时时间2019-01-01）**

-   分支节点分支选择结果

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081637252_zh-CN.png)

-   节点“最后一天执行”被置为空跑

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081737253_zh-CN.png)

-   节点“除了最后一天之外运行”正常执行

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/103578/155142081737257_zh-CN.png)


## 总结 {#section_xsb_4ws_lgb .section}

基于分支节点，您已经实现了**每个月最后一天执行**的这一目标，当然这只是分支节点最简单的使用方法。将赋值节点与分支节点配合使用，您可以组合出各种各样的条件满足业务上的需求。

最后回顾分支节点使用要点：

-   DataWorks捕获赋值节点的最后一条SELECT语句或者最后一行标准输出流，作为赋值节点的输出，供下游引用。
-   分支节点的每一个输出都被关联了条件，下游挂分支节点作为上游，需要了解每个输出关联的条件的意义再选择。
-   未被选中的分支会被置为空跑，并且空跑属性会一直向下传递，直到遇到归并节点。
-   归并节点除了阻断空跑属性外，还有更多更强大的功能等待您的挖掘。

