# 配置ODPS数据源规则 {#concept_j2n_f13_r2b .concept}

本文将为您介绍如何配置ODPS数据源。

规则配置模块是数据质量（DQC）中最核心的部分，根据数据源的不同分为ODPS数据源和DataHub数据源。

## 选择数据源 {#section_tc4_h13_r2b .section}

1.  单击左侧导航栏的**规则配置**，进入规则配置页面。
2.  选择**ODPS数据源**，即可显示当前数据源下所有的Topic。

    您也可通过数据源选择下的搜索功能，快速定位到其他数据源下查看Topic。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848793_zh-CN.png)

3.  单击右侧的**配置监控规则**。

**说明：** 

除此方法外，您还可通过[我的订阅](intl.zh-CN/使用指南/数据质量/我的订阅.md#)，选择**ODPS数据源**，单击右侧的**分区表达式**，进入规则配置页面进行配置。

## 配置分区表达式 {#section_bby_bb3_r2b .section}

分区表达式是DQC用来确定所配置的某条规则应检查对应表的哪一个分区的表达式说明。

如果您的检查对象为非分区表，则此处可填写为：ALL\_PARTITIONS；如您的表为分区表，则可以配置为业务日期的表达式（如：$\[yyyymmdd\]），同时也可以配置为相关格式的正则表达式。

进入数据表的规则配置页面，单击左上角的**+**，添加分区表达式。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848796_zh-CN.png)

-   新建分区的表达式：单击左上角的**+**，会弹出分区配置窗口，您可根据自身需求编辑符合语法的分区表达式。非分区表可以直接选择推荐的分区表达式中的**NOTAPARTITIONTABLE**。
-   一级分区的表达式格式：分区名=分区值，分区值可以是固定值可以是内置参数表达式。
-   多级分区表达式格式：1级分区名=分区值/2级分区名=分区值/N级分区名=分区值，分区值可以是固定值，可以是内置参数表达式。

## 内置参数表达式说明 {#section_hhv_sb3_r2b .section}

-   $\[yyyymmddmiss-1\]

    格式为`yyyymmddmiss-1`，默认为当前实例运行的业务日期的前一天。

-   $\[yyyymmddhh24miss\]

    格式为`yyyymmddhh24miss`，当前实例运行的业务日期。

    -   yyyy表示4位数年份
    -   mm表示2位数月份
    -   dd表示2位数天
    -   hh24表示24小时制的时
    -   mi表示2位数分钟
    -   ss表示2位数秒

## 获取+/-周期的方法 {#section_il4_xb3_r2b .section}

分区表达式周期由配置的业务日期决定，例如配置运行时间为前5天，则周期为每5天调度一次。

-   前N天：$\[yyyymmdd-N\]
-   每月1日：$\[yyyymm01-1\]
-   N月前1日：$\[yyyymm01-Nm\]
-   每月最后一天：$\[yyyymmld-1\]
-   N月前最后一天：$\[yyyymmld-Nm\]
-   一个小时前：$\[hh24miss-1/24\]
-   半个小时前：$\[hh24miss-30/24/60\]

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848798_zh-CN.png)

-   已添加分区表达式：表示该表目前已经添加的分区表达式。
-   推荐的分区表达式：表示数据质量系统推荐的分区表达式。可以根据需求在推荐的分区表达式列表中进行选择添加。在列表中找到符合需求的分区表达式，添加成功后会在左侧已经添加的分区表达式处显示。

    如果不知道推荐的表达式和自定义的表达式是否符合自己预期，可以使用分区计算功能进行计算。

-   删除已添加分区表达式：不需要的分区表达式可以删除，如果该分区表达式已经配置有规则，删除时会删除该表达式下所有规则。

**说明：** 

下文示例中，以分区名dt为例，同时，如果表是动态分区表，则不建议使用含有正则的分区表达式。

|分区表达式|说明|
|:----|:-|
|ALL\_PARTITIONS|非分区表可以选择这个分区表达式|
|dt=<\[a-zA-Z0-9\_-\]\*\>|一般用于小时任务，当表分区为小时分区时，会自动将正则表达式替换为表的分区表达式。|
|dt=$\[yyyymmdd-N\]|代表前N天|
|dt=$\[yyyymm01-1\]|代表每月1日|
|dt=$\[yyyymm01-Nm\]|代表N月前1日|
|dt=$\[yyyymmld-1\]|代表每月最后一天|
|dt=$\[yyyymmld-1m\]|代表N月前最后一天|
|dt=$\[hh24miss-1/24\]|代表一个小时前|
|dt=$\[hh24miss-30/24/60\]|代表半个小时前|

当鼠标单击输入表达式的窗口时，会下拉显示数据质量为您推荐的分区表达式。

-   如果有符合预期的表达式，单击该行则会自动同步到输出窗口。
-   如果没有满足的分区表达式，您可以根据需求自己输入。

操作完成后可以单击**计算**，数据质量会按照当前时间（调度时间）计算出分区表达式的计算结果，方便对分区表达式的正确性做验证。

最后单击**确认**。

## 关联调度 {#section_qym_j23_r2b .section}

如果要在生产链路上监控离线数据质量，需要将数据质量关联调度。目前有两个关联入口，一个在运维中心，另外一个在数据质量的规则配置页面。

数据质量的关联调度可以添加已经创建好的任务节点，关联调度之后任务才可以自动运行（如果不需要则可以选择不关联，跳过此步骤即可）。目前关联调度支持模糊搜索，具体的任务节点可以进入运维中心查看。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848804_zh-CN.png)

**说明：** 

在完成DQC规则配置并关联已提交的调度任务后，DQC会根据所关联的周期任务定时时间对表进行检查。

您也可以进入运维中心页面，设置关联调度配置质量监控。

1.  单击对应任务后的**更多**，选择**配置质量监控**。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848805_zh-CN.png)

2.  输入表名进行搜索，单击相应分区表达式后的**配置**（您也可自行添加分区表达式），即可对此分区表达式进行配置。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848808_zh-CN.png)


## 创建规则 {#section_jdy_hh3_r2b .section}

创建规则是数据质量模块的核心内容，您可根据表的实际需要创建规则。

目前创建规则的方式包括模板规则和自助规则，具体用法根据实际需要选择，两种规则又分为**添加监控规则**和**快捷添加**两部分。

创建完成后单击**批量保存**，即可将创建的所有规则保存到已建好的分区表达式。

**模板规则**

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848809_zh-CN.png)

-   **添加监控规则**
    -   字段类型：包括表级规则和字段级规则，字段级规则可针对表中的具体字段配置监控规则。此处选择为表级规则，页面中其他设置项对应为表级规则配置项。
    -   强弱：配置规则的强弱。当强被勾选，任务运行时若触发了红色阈值，则会将任务置为失败状态。
    -   模板类型：系统内置的表级监控规则模块。
    -   趋势：根据所选模板类型的不同，趋势可包括绝对值、上升和下降等类型。
    -   波动值比较：设置波动值的橙色阈值和红色阈值。您可通过拖动进度条来设置，也可直接输入阈值。
-   **快捷添加**
    -   字段名：只有字段级规则，字段级规则可针对表中具体字段进行配置监控规则。此处选择具体字段，对其设置字段级规则。
    -   规则类型：选择字段空值或字段重复值。

如果模板规则不能够满足您对分区表达式中数据质量的监控需求，您还可通过创建自助规则来满足其个性化的监控规则。

**自助规则**

在创建自助规则页面，您可根据自身需求选择创建表级规则或自定义SQL。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848814_zh-CN.png)

-   **添加监控规则**
    -   字段类型：可选项包括表级规则、字段级规则和自定义SQL。此处选择表级规则，页面中其他设置项对应为表级自助规则配置项。
    -   强弱：当强被勾选，任务运行时若触发了红色阈值，则会将任务置为失败状态。
    -   统计函数：包括count和count/table\_count两种。
    -   过滤条件：自定义SQL。
    -   校验方法：可进行选择系统内置的校验方法，校验方法默认为固定值。
    -   趋势：包括绝对值、上升和下降三种类型。如果统计函数设置为count/table\_count，则趋势默认为固定值。
    -   比较方式：根据实际的需要有大于、大于等于、等于、不等于、小于和小于等于多种选择。
    -   期望值：期望达到的目标值。
    -   描述：该自助规则的详细描述信息。
-   **快捷添加**
    -   规则类型：有表行数大于0、多字段重复值两种类型。
    -   字段名：当选择规则类型为多字段重复值，则显示需要添加的字段名，可以添加多个字段名。

## 试跑 {#section_bpf_sk3_r2b .section}

成功配置规则后，可针对某个分区表达式下所有规则进行试跑，并查看试跑的校验结果。

1.  选择需要试跑的调度日期，单击**试跑**，即可进行试跑。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848816_zh-CN.png)

    -   **试跑分区**：实际分区会随着业务日期变化而改变。如果为NOPARTITIONTABLE，则会自动添加实际分区。
    -   **调度时间**：默认为当前时间。
2.  单击**试跑成功！点击查看试跑结果**，即可跳转至[任务查询](intl.zh-CN/使用指南/数据质量/任务查询/查看ODPS数据源任务.md#)页面，查看校验结果。

## 转交责任人 {#section_fj5_4c4_r2b .section}

当责任人离职或者转岗，可以将分区表达式负责人转交给其他项目成员。默认分区表达式负责人为创建人。

当把鼠标放在责任人上时，会在后面显示一个隐藏按钮，单击可修改责任人，输入交接人的名称，单击**确认**即可提交成功。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848817_zh-CN.png)

## 更多 {#section_atk_vc4_r2b .section}

**更多**选项中包括分区操作日志、上一次校验结果和复制规则。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848818_zh-CN.png)

-   **分区操作日志**：显示对当前分区表达式所有的规则设置的记录。
-   **上一次校验结果**：会跳转到任务查询界面，查看当前分区表达式下的运行结果情况，您还可在此查看历史结果。
-   **复制规则**：可将当前设置的规则复制到目标表达式中，还可将订阅人同步传导过去。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16396/15367419848821_zh-CN.png)


ODPS数据源支持的模板规则请参见[模板规则说明](intl.zh-CN/使用指南/数据质量/模板规则说明.md#)。

